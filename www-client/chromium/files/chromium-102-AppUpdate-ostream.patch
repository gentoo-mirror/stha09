From abab9c681336e69eab51e0fee13c15210dc5aca Mon Sep 17 00:00:00 2001
From: Stephan Hartmann <stha09@googlemail.com>
Date: Sun, 20 Mar 2022 18:11:59 +0000
Subject: [PATCH] libstdc++: fix ostream operator<< for apps::AppUpdate

std::unique_ptr has no operator<< in libstdc++. Even it would
exist, it would just return the pointer value and not the content.
Implement the necessary ToString() methods.

---
 .../app_service/public/cpp/app_update.cc      |  2 +-
 .../app_service/public/cpp/intent_filter.cc   | 53 +++++++++++++++++++
 .../app_service/public/cpp/intent_filter.h    | 41 +++++++-------
 3 files changed, 77 insertions(+), 19 deletions(-)

diff --git a/components/services/app_service/public/cpp/app_update.cc b/components/services/app_service/public/cpp/app_update.cc
index 723d349..57d17eb 100644
--- a/components/services/app_service/public/cpp/app_update.cc
+++ b/components/services/app_service/public/cpp/app_update.cc
@@ -1028,7 +1028,7 @@ std::ostream& operator<<(std::ostream& out, const AppUpdate& app) {
   out << "Paused: " << PRINT_OPTIONAL_VALUE(Paused) << std::endl;
   out << "IntentFilters: " << std::endl;
   for (const auto& filter : app.IntentFilters()) {
-    out << filter << std::endl;
+    out << filter->ToString();
   }
 
   out << "ResizeLocked: " << PRINT_OPTIONAL_VALUE(ResizeLocked) << std::endl;
diff --git a/components/services/app_service/public/cpp/intent_filter.cc b/components/services/app_service/public/cpp/intent_filter.cc
index 7cc8315..df501c5 100644
--- a/components/services/app_service/public/cpp/intent_filter.cc
+++ b/components/services/app_service/public/cpp/intent_filter.cc
@@ -6,6 +6,23 @@
 
 namespace apps {
 
+APP_ENUM_TO_STRING(PatternMatchType,
+                   kNone,
+                   kLiteral,
+                   kPrefix,
+                   kGlob,
+                   kMimeType,
+                   kFileExtension,
+                   kIsDirectory,
+                   kSuffix)
+APP_ENUM_TO_STRING(ConditionType,
+                   kScheme,
+                   kHost,
+                   kPattern,
+                   kAction,
+                   kMimeType,
+                   kFile)
+
 ConditionValue::ConditionValue(const std::string& value,
                                PatternMatchType match_type)
     : value(value), match_type(match_type) {}
@@ -20,6 +37,13 @@ bool ConditionValue::operator!=(const ConditionValue& other) const {
   return !(*this == other);
 }
 
+std::string ConditionValue::ToString() const {
+  std::stringstream out;
+  out << "   match_type: " << EnumToString(match_type);
+  out << " value: " << value << std::endl;
+  return out.str();
+}
+
 Condition::Condition(ConditionType condition_type,
                      ConditionValues condition_values)
     : condition_type(condition_type),
@@ -55,6 +79,18 @@ ConditionPtr Condition::Clone() const {
   return std::make_unique<Condition>(condition_type, std::move(values));
 }
 
+std::string Condition::ToString() const {
+  std::stringstream out;
+  out << "  condition_type: " << EnumToString(condition_type) << std::endl;
+  if (!condition_values.empty()) {
+    out << "  condition_values: " << std::endl;
+    for (const auto& condition_value : condition_values) {
+      out << condition_value->ToString();
+    }
+  }
+  return out.str();
+}
+
 IntentFilter::IntentFilter() = default;
 IntentFilter::~IntentFilter() = default;
 
@@ -186,6 +223,24 @@ bool IntentFilter::IsFileExtensionsFilter() {
   return true;
 }
 
+std::string IntentFilter::ToString() const {
+  std::stringstream out;
+  if (activity_name.has_value()) {
+    out << " activity_name: " << activity_name.value() << std::endl;
+  }
+  if (activity_label.has_value()) {
+    out << " activity_label: " << activity_label.value() << std::endl;
+  }
+  if (!conditions.empty()) {
+    out << " conditions:" << std::endl;
+    for (const auto& condition : conditions) {
+      out << condition->ToString();
+    }
+  out << std::endl;
+  }
+  return out.str();
+}
+
 IntentFilters CloneIntentFilters(const IntentFilters& intent_filters) {
   IntentFilters ret;
   for (const auto& intent_filter : intent_filters) {
diff --git a/components/services/app_service/public/cpp/intent_filter.h b/components/services/app_service/public/cpp/intent_filter.h
index 042f43b..9d80966 100644
--- a/components/services/app_service/public/cpp/intent_filter.h
+++ b/components/services/app_service/public/cpp/intent_filter.h
@@ -12,6 +12,7 @@
 
 #include "base/component_export.h"
 #include "base/containers/flat_map.h"
+#include "components/services/app_service/public/cpp/macros.h"
 #include "components/services/app_service/public/mojom/types.mojom.h"
 #include "third_party/abseil-cpp/absl/types/optional.h"
 
@@ -31,26 +32,24 @@ enum class IntentFilterMatchLevel {
 };
 
 // The intent filter matching condition types.
-enum class ConditionType {
-  kScheme,    // Matches the URL scheme (e.g. https, tel).
-  kHost,      // Matches the URL host (e.g. www.google.com).
-  kPattern,   // Matches the URL pattern (e.g. /abc/*).
-  kAction,    // Matches the action type (e.g. view, send).
-  kMimeType,  // Matches the top-level mime type (e.g. text/plain).
-  kFile,      // Matches against all files.
-};
+ENUM(ConditionType,
+     kScheme,    // Matches the URL scheme (e.g. https, tel).
+     kHost,      // Matches the URL host (e.g. www.google.com).
+     kPattern,   // Matches the URL pattern (e.g. /abc/*).
+     kAction,    // Matches the action type (e.g. view, send).
+     kMimeType,  // Matches the top-level mime type (e.g. text/plain).
+     kFile)      // Matches against all files.
 
 // The pattern match type for intent filter pattern condition.
-enum class PatternMatchType {
-  kNone = 0,
-  kLiteral,
-  kPrefix,
-  kGlob,
-  kMimeType,
-  kFileExtension,
-  kIsDirectory,
-  kSuffix
-};
+ENUM(PatternMatchType,
+     kNone = 0,
+     kLiteral,
+     kPrefix,
+     kGlob,
+     kMimeType,
+     kFileExtension,
+     kIsDirectory,
+     kSuffix)
 
 // For pattern type of condition, the value match will be based on the pattern
 // match type. If the match_type is kNone, then an exact match with the value
@@ -64,6 +63,8 @@ struct COMPONENT_EXPORT(APP_TYPES) ConditionValue {
   bool operator==(const ConditionValue& other) const;
   bool operator!=(const ConditionValue& other) const;
 
+  std::string ToString() const;
+
   std::string value;
   PatternMatchType match_type;  // This will be None for non pattern conditions.
 };
@@ -85,6 +86,8 @@ struct COMPONENT_EXPORT(APP_TYPES) Condition {
 
   std::unique_ptr<Condition> Clone() const;
 
+  std::string ToString() const;
+
   ConditionType condition_type;
   ConditionValues condition_values;
 };
@@ -129,6 +132,8 @@ struct COMPONENT_EXPORT(APP_TYPES) IntentFilter {
   // Returns true if the filter only contains file extension pattern matches.
   bool IsFileExtensionsFilter();
 
+  std::string ToString() const;
+
   Conditions conditions;
 
   // Activity which registered this filter. We only fill this field for ARC
-- 
2.34.1

